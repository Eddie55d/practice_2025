;; Определяем все необходимые шаблоны
(deftemplate пациент
(slot имя (default "Пациент"))
(slot возраст (type INTEGER))
(slot пол (allowed-symbols мужской женский))
(slot беременность (default нет) (allowed-symbols да нет))
)

(deftemplate симптом
(slot название)
(slot тип (allowed-symbols боль температура воспаление аллергия пищеварение))
(slot интенсивность (type NUMBER) (default 1.0))
)

(deftemplate препарат
(slot название)
(slot форма-выпуска (allowed-symbols таблетки капсулы сироп мазь свечи спрей порошок))
(slot категория (allowed-symbols обезболивающее жаропонижающее противовоспалительное антигистаминное пищеварение))
(slot дозировка)
(slot беременность (default "с осторожностью"))
(slot минимальный-возраст (type INTEGER) (default 0))
(slot цена (type NUMBER))
(slot рейтинг-эффективности (type NUMBER) (range 0.0 10.0))
)

(deftemplate рекомендация
(slot препарат)
(slot форма)
(slot дозировка)
(slot цена)
(slot приоритет)
(slot обоснование)
(slot беременность-статус)  
(slot разрешено-беременным) 
)

(deftemplate потребность
(slot категория)
(slot приоритет)
(slot обоснование)
)


(deftemplate кандидат
(slot препарат)
(slot рейтинг (type NUMBER))
(slot приоритет)
(slot обоснование)
)

;; Добавляем шаблон обрабатывается в начало
(deftemplate обрабатывается
    (slot потребность)
)

;; База данных препаратов - ОЧИЩЕННАЯ ВЕРСИЯ
(deffacts база-препаратов
;; Обезболивающие и жаропонижающие
(препарат
(название "Парацетамол")
(форма-выпуска таблетки)
(категория жаропонижающее)
(дозировка "500 мг 3-4 раза в день, максимально 4 г/сутки")
(беременность "разрешено")
(минимальный-возраст 6)
(цена 85.50)
(рейтинг-эффективности 8.5)
)

(препарат
(название "Ибупрофен")
(форма-выпуска таблетки)
(категория противовоспалительное)
(дозировка "200-400 мг 3 раза в день после еды")
(беременность "запрещено-в-3-триместре")
(минимальный-возраст 12)
(цена 120.00)
(рейтинг-эффективности 9.0)
)


(препарат
(название "Нурофен")
(форма-выпуска таблетки)
(категория обезболивающее)
(дозировка "200-400 мг 3-4 раза в день после еды")
(беременность "запрещено-в-3-триместре")
(минимальный-возраст 12)
(цена 280.00)
(рейтинг-эффективности 8.8)
)


(препарат
(название "Нурофен для детей")
(форма-выпуска сироп)
(категория обезболивающее)
(дозировка "5-10 мл 3 раза в день (детская дозировка)")
(беременность "запрещено-в-3-триместре")
(минимальный-возраст 3)
(цена 280.00)
(рейтинг-эффективности 8.8)
)

;; Жаропонижающие
(препарат
(название "Аспирин")
(форма-выпуска таблетки)
(категория жаропонижающее)
(дозировка "500 мг каждые 4-6 часов, не более 3 г/сутки")
(беременность "запрещено")
(минимальный-возраст 12)
(цена 65.00)
(рейтинг-эффективности 8.0)
)

;; Антигистаминные
(препарат
(название "Лоратадин")
(форма-выпуска таблетки)
(категория антигистаминное)
(дозировка "1 таблетка 10 мг 1 раз в день")
(беременность "с осторожностью")
(минимальный-возраст 2)
(цена 65.00)
(рейтинг-эффективности 7.5)
)

(препарат
(название "Цетрин")
(форма-выпуска таблетки)
(категория антигистаминное)
(дозировка "1 таблетка 10 мг 1 раз в день")
(беременность "запрещено")
(минимальный-возраст 6)
(цена 150.00)
(рейтинг-эффективности 8.0)
)

(препарат
(название "Супрастин")
(форма-выпуска таблетки)
(категория антигистаминное)
(дозировка "1 таблетка 25 мг 3-4 раза в день")
(беременность "запрещено")
(минимальный-возраст 3)
(цена 120.00)
(рейтинг-эффективности 7.0)
)

;; Для пищеварения
(препарат
(название "Мезим")
(форма-выпуска таблетки)
(категория пищеварение)
(дозировка "1-2 таблетки во время еды")
(беременность "разрешено")
(минимальный-возраст 3)
(цена 320.00)
(рейтинг-эффективности 8.2)
)

(препарат
(название "Смекта")
(форма-выпуска порошок)
(категория пищеварение)
(дозировка "1 пакетик 3 раза в день")
(беременность "разрешено")
(минимальный-возраст 0)
(цена 140.00)
(рейтинг-эффективности 7.8)
)

(препарат
(название "Эспумизан")
(форма-выпуска капсулы)
(категория пищеварение)
(дозировка "2 капсулы 3-5 раз в день после еды")
(беременность "разрешено")
(минимальный-возраст 6)
(цена 280.00)
(рейтинг-эффективности 8.5)
)

;; Противовоспалительные
(препарат
(название "Найз")
(форма-выпуска таблетки)
(категория противовоспалительное)
(дозировка "1 таблетка 100 мг 2 раза в день после еды")
(беременность "запрещено")
(минимальный-возраст 12)
(цена 220.00)
(рейтинг-эффективности 8.7)
)
)






;; Обновляем правила определения потребностей - С ИНФОРМАЦИЕЙ О ПАЦИЕНТЕ
(defrule определение-потребности-боль
?пациент <- (пациент (имя ?имя) (возраст ?возраст))
(симптом (название ?название) (тип боль) (интенсивность ?инт))
=>
(assert (потребность
(категория обезболивающее)
(приоритет ?инт)
(обоснование (str-cat "Болевой синдром у пациента " ?имя " (" ?возраст " лет), интенсивность " ?инт "/10"))))
(printout t "✓ У " ?имя " болевой синдром. Требуется обезболивающее." crlf)
)

(defrule определение-потребности-температура
?пациент <- (пациент (имя ?имя) (возраст ?возраст))
(симптом (название ?название) (тип температура) (интенсивность ?инт))
=>
(assert (потребность
(категория жаропонижающее)
(приоритет ?инт)
(обоснование (str-cat "Повышенная температура у пациента " ?имя " (" ?возраст " лет), интенсивность " ?инт "/10"))))
(printout t "✓ У " ?имя " повышенная температура. Требуется жаропонижающее." crlf)
)

(defrule определение-потребности-аллергия
?пациент <- (пациент (имя ?имя) (возраст ?возраст))
(симптом (название ?название) (тип аллергия) (интенсивность ?инт))
=>
(assert (потребность
(категория антигистаминное)
(приоритет ?инт)
(обоснование (str-cat "Аллергическая реакция у пациента " ?имя " (" ?возраст " лет), интенсивность " ?инт "/10"))))
(printout t "✓ У " ?имя " аллергическая реакция. Требуется антигистаминное." crlf)
)

(defrule определение-потребности-пищеварение
?пациент <- (пациент (имя ?имя) (возраст ?возраст))
(симптом (название ?название) (тип пищеварение) (интенсивность ?инт))
=>
(assert (потребность
(категория пищеварение)
(приоритет ?инт)
(обоснование (str-cat "Проблемы с пищеварением у пациента " ?имя " (" ?возраст " лет), интенсивность " ?инт "/10"))))
(printout t "✓ У " ?имя " проблемы с пищеварением. Требуется гастропротектор." crlf)
)

(defrule определение-потребности-воспаление
?пациент <- (пациент (имя ?имя) (возраст ?возраст))
(симптом (название ?название) (тип воспаление) (интенсивность ?инт))
=>
(assert (потребность
(категория противовоспалительное)
(приоритет ?инт)
(обоснование (str-cat "Воспалительный процесс у пациента " ?имя " (" ?возраст " лет), интенсивность " ?инт "/10"))))
(printout t "✓ У " ?имя " воспалительный процесс. Требуется противовоспалительное." crlf)
)










;; Вспомогательные функции для проверок - УЛУЧШЕННАЯ ВЕРСИЯ
(deffunction can-use-during-pregnancy (?разрешено ?беременность ?пол)
(if (eq ?пол мужской) then
(return TRUE) ; ← Мужчинам всегда разрешено
)
(if (eq ?беременность нет) then
(return TRUE) ; ← Небеременным женщинам разрешено
)
;; Для беременных женщин - БОЛЕЕ СТРОГАЯ ПРОВЕРКА
(if (str-index "запрещено" ?разрешено) then
(return FALSE)
)
(return (str-index "разрешено" ?разрешено))
)


;; форматирование цены
(deffunction format-price (?price)
    (bind ?int-part (integer ?price))
    (bind ?dec-part (round (* (- ?price ?int-part) 100)))
    (return (str-cat ?int-part "." (if (< ?dec-part 10) then "0" else "") ?dec-part))
)


(defrule вывод-рекомендаций
    ?пациент <- (пациент (имя ?имя) (беременность ?беременность))
    =>
    (printout t crlf "==========================================" crlf)
    (printout t "РЕКОМЕНДАЦИИ ДЛЯ: " ?имя crlf)
    (printout t "==========================================" crlf)

    (bind ?count 0)
    (bind ?uncovered-count 0)
    
    ;; Сначала выводим найденные рекомендации
    (do-for-all-facts ((?r рекомендация)) TRUE
        (bind ?count (+ ?count 1))
        (printout t crlf ?count ". " (fact-slot-value ?r препарат) crlf)
        (printout t " • Форма выпуска: " (fact-slot-value ?r форма) crlf)
        (printout t " • Дозировка: " (fact-slot-value ?r дозировка) crlf)
        (printout t " • Цена: " (format-price (fact-slot-value ?r цена)) " руб." crlf)
        (printout t " • Показание: " (fact-slot-value ?r обоснование) crlf)

        (if (eq (fact-slot-value ?r беременность-статус) да) then
            (printout t 
            " • Статус беременности: да" crlf
            " • Разрешён при беременности: " 
            (if (str-index "разрешено" (fact-slot-value ?r разрешено-беременным)) then
                "Да"
            else
                "Нет"
            ) crlf
            )
        )
        (printout t " ---------------------" crlf)
    )

    ;; Затем выводим только те потребности, для которых НЕ нашли препаратов
    (do-for-all-facts ((?p потребность)) TRUE
        ;; Проверяем, есть ли рекомендация с таким же обоснованием
        (bind ?найдено FALSE)
        (do-for-all-facts ((?r рекомендация)) TRUE
            (if (eq (fact-slot-value ?p обоснование) (fact-slot-value ?r обоснование)) then
                (bind ?найдено TRUE)
            )
        )
        
        ;; Если не нашли рекомендацию для этой потребности - выводим
        (if (not ?найдено) then
            (bind ?uncovered-count (+ ?uncovered-count 1))
            (bind ?count (+ ?count 1))
            (printout t crlf ?count ". [НЕ НАЙДЕНО ПРЕПАРАТА]" crlf)
            (printout t " • Показание: " (fact-slot-value ?p обоснование) crlf)
            (printout t " • Статус: требуется консультация врача" crlf)
            (printout t " • Причина: нет подходящих препаратов в базе данных" crlf)
            (printout t " ---------------------" crlf)
        )
        (retract ?p)  ; Очищаем после показа
    )

    (if (= ?count 0) then
        (printout t "✗ Подходящих препаратов не найдено." crlf)
    else
        (printout t crlf "Всего пунктов в рекомендациях: " ?count)
        (if (> ?uncovered-count 0) then
            (printout t " (из них препаратов: " (- ?count ?uncovered-count) ", требуется консультация: " ?uncovered-count ")")
        )
        (printout t crlf)
    )
)


;; Упрощенная функция ввода симптомов (только выбор типа)
(deffunction ввод-симптомов ()
(printout t crlf "=== ВВОД СИМПТОМОВ ===" crlf)
(printout t "Выберите тип симптомов. Для завершения введите '0'" crlf)
(bind ?номер 1)
(while TRUE do
(printout t crlf "Симптом " ?номер " - выберите тип:" crlf)
(printout t " 1 - боль" crlf)
(printout t " 2 - температура" crlf)
(printout t " 3 - воспаление" crlf)
(printout t " 4 - аллергия" crlf)
(printout t " 5 - пищеварение" crlf)
(printout t " 0 - завершить ввод" crlf)
(printout t "Ваш выбор: ")
(bind ?выбор (read))

(if (eq ?выбор 0) then (return))

(bind ?тип неизвестно)
(if (eq ?выбор 1) then (bind ?тип боль))
(if (eq ?выбор 2) then (bind ?тип температура))
(if (eq ?выбор 3) then (bind ?тип воспаление))
(if (eq ?выбор 4) then (bind ?тип аллергия))
(if (eq ?выбор 5) then (bind ?тип пищеварение))

(if (eq ?тип неизвестно) then
(printout t "Ошибка! Выберите число от 0 до 5." crlf)
else
(printout t "Интенсивность (1-10): ")
(bind ?инт (read))

;; Автоматически генерируем название симптома по типу
(bind ?название "симптом")
(if (eq ?тип боль) then (bind ?название "болевой синдром"))
(if (eq ?тип температура) then (bind ?название "повышенная температура"))
(if (eq ?тип воспаление) then (bind ?название "воспалительный процесс"))
(if (eq ?тип аллергия) then (bind ?название "аллергическая реакция"))
(if (eq ?тип пищеварение) then (bind ?название "проблемы с пищеварением"))

(assert (симптом (название ?название) (тип ?тип) (интенсивность ?инт)))
(printout t "✓ Добавлен симптом: " ?название " (интенсивность: " ?инт ")" crlf)
(bind ?номер (+ ?номер 1))
)
)
)


(defrule подбор-препарата-по-симптомам
    ?пациент <- (пациент
        (имя ?имя)
        (возраст ?возраст)
        (беременность ?беременность)
        (пол ?пол))
    ?потребность <- (потребность
        (категория ?кат)
        (приоритет ?приор)
        (обоснование ?обосн))
    ?препарат <- (препарат
        (название ?название-препарата)
        (категория ?кат)
        (рейтинг-эффективности ?рейтинг)
        (минимальный-возраст ?мин-возраст)
        (беременность ?разрешено-беременным)
        (форма-выпуска ?форма)
        (дозировка ?дозировка)
        (цена ?цена))

    ;; Проверка возраста
    (test (>= ?возраст ?мин-возраст))

    (test (or 
        (and (>= ?возраст 18) (not (str-index "дет" ?название-препарата)))
        (and (< ?возраст 18) (str-index "дет" ?название-препарата))
    ))

    ;; Проверка беременности
    (test (can-use-during-pregnancy ?разрешено-беременным ?беременность ?пол))

    ;; Проверка на отсутствие дубликатов
    (not (кандидат (препарат ?название-препарата)))
    (not (обрабатывается (потребность ?потребность))) ; Используем существующий шаблон

    =>

    (bind ?финальный-рейтинг (* ?рейтинг ?приор))

    (assert (кандидат
        (препарат ?название-препарата)
        (рейтинг ?финальный-рейтинг)
        (приоритет ?приор)
        (обоснование ?обосн)))

    (assert (обрабатывается (потребность ?потребность))) ; Отмечаем обработку

    (if (and (>= ?возраст 18) (str-index "дет" ?название-препарата))
    then
    (printout t "⚠️ Учитывая возраст выбран препарат " ?название-препарата " - детский препарат для взрослого" crlf))

    (if (and (>= ?возраст 18) (not (str-index "дет" ?название-препарата)))
    then
    (printout t "✓ Учитывая возраст выбран препарат " ?название-препарата " - приоритет для взрослого" crlf))

    (if (eq ?беременность да) then
     (printout t 
      "✓ Беременность: да, "
      (if (str-index "разрешено" ?разрешено-беременным) then
       "препарат разрешён"
       else
       "препарат противопоказан!"
      ) crlf
     )
    )

    (printout t "✓ Учитывая симптом подобран препарат: " ?название-препарата
    " (категория: " ?кат ", рейтинг: " ?финальный-рейтинг ")" crlf)
)



(defrule сформировать-финальные-рекомендации
?кандидат <- (кандидат
 (препарат ?название)
 (рейтинг ?рейтинг)
 (приоритет ?приор)
 (обоснование ?полное-обоснование))
?препарат <- (препарат
 (название ?название)
 (форма-выпуска ?форма)
 (дозировка ?доза)
 (цена ?цена)
 (беременность ?беременное-состояние))
?пациент <- (пациент (беременность ?беременность))
=>
(assert (рекомендация
 (препарат ?название)
 (форма ?форма)
 (дозировка ?доза)
 (цена ?цена)
 (приоритет ?рейтинг)
 (обоснование ?полное-обоснование)
 (беременность-статус ?беременность)
 (разрешено-беременным ?беременное-состояние)))

(retract ?кандидат)
)




(defrule показать-все-рекомендации
;(declare (salience -1))
(not (exists (рекомендация)))
=>
(printout t crlf)
(printout t "==========================================" crlf)
(printout t "Итоговое заключение" crlf)
(printout t "==========================================" crlf)

(do-for-all-facts ((?f рекомендация)) TRUE
(printout t crlf)
(printout t "Рекомендация: " crlf)
(printout t "Препарат: " (fact-slot-value ?f препарат) crlf)
(printout t "Форма выпуска: " (fact-slot-value ?f форма) crlf)
(printout t "Дозировка: " (fact-slot-value ?f дозировка) crlf)
(printout t "Цена: " (fact-slot-value ?f цена) crlf)
(printout t "Приоритет: " (fact-slot-value ?f приоритет) crlf)
(printout t "Обоснование: " (fact-slot-value ?f обоснование) crlf)
)

(halt)
)


;; Функция создания пациента
(deffunction создать-пациента ()
(printout t crlf "=== РЕГИСТРАЦИЯ ПАЦИЕНТА ===" crlf)
(printout t "Имя: ")
(bind ?имя (readline))
(printout t "Возраст: ")
(bind ?возраст (read))
(printout t "Пол (м/ж): ")
(bind ?пол-ввод (readline)) 

;; Правильно обрабатываем ввод пола
(bind ?пол мужской) ;; значение по умолчанию
(if (or (eq ?пол-ввод "ж") (eq ?пол-ввод "женский") (eq ?пол-ввод "f")) then
(bind ?пол женский)
)

(bind ?беременность нет) ;; по умолчанию не беременна

;; СПРАШИВАЕМ ПРО БЕРЕМЕННОСТЬ ТОЛЬКО ДЛЯ ЖЕНЩИН
(if (eq ?пол женский) then
(printout t "Беременность (д/н): ")
(bind ?берем-ввод (readline))
(if (or (eq ?берем-ввод "д") (eq ?берем-ввод "y") (eq ?берем-ввод "да")) then
(bind ?беременность да)
)
)

(assert (пациент
(имя ?имя)
(возраст ?возраст)
(пол ?пол)
(беременность ?беременность)
))

;; ДЕБАГ: Выводим данные пациента для проверки
(printout t "✓ Зарегистрирован пациент: " ?имя ", " ?возраст " лет, "
(if (eq ?пол мужской) then "мужской" else "женский")
(if (eq ?беременность да) then ", беременна" else "") crlf)
)



;; Основная функция запуска системы
(deffunction запуск-системы ()
(reset)
(printout t "==========================================" crlf)
(printout t "ЭКСПЕРТНАЯ СИСТЕМА 'ФАРМАЦЕВТ-КОНСУЛЬТАНТ'" crlf)
(printout t "==========================================" crlf)
(создать-пациента)
(ввод-симптомов)
(printout t crlf "Анализируем симптомы и подбираем препараты..." crlf)
(run)
(printout t crlf "==========================================" crlf)
(printout t "КОНЕЦ РАБОТЫ СИСТЕМЫ" crlf)
(printout t "==========================================" crlf)

    ;; Добавляем очистку после завершения
    (do-for-all-facts ((?f пациент)) TRUE (retract ?f))
    (do-for-all-facts ((?f симптом)) TRUE (retract ?f))
    (do-for-all-facts ((?f потребность)) TRUE (retract ?f))
    (do-for-all-facts ((?f рекомендация)) TRUE (retract ?f))
    (do-for-all-facts ((?f кандидат)) TRUE (retract ?f))
)

;; Функция для нового пациента
(deffunction новый-пациент ()
(reset)
(printout t crlf "=== НОВЫЙ СЕАНС ===" crlf)
(do-for-all-facts ((?f пациент)) TRUE (retract ?f))
(do-for-all-facts ((?f симптом)) TRUE (retract ?f))
(do-for-all-facts ((?f потребность)) TRUE (retract ?f))
(do-for-all-facts ((?f рекомендация)) TRUE (retract ?f))
(do-for-all-facts ((?f кандидат)) TRUE (retract ?f))
(запуск-системы)
)
